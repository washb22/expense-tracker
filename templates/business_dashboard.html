{% extends "layout.html" %}

{% block title %}ì‚¬ì—… ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<div class="header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1>ì‚¬ì—… ëŒ€ì‹œë³´ë“œ</h1>
        <p>ë§¤ì¶œê³¼ ì§€ì¶œì„ í†µí•© ê´€ë¦¬í•˜ì—¬ ìˆœì´ìµì„ í™•ì¸í•˜ì„¸ìš”.</p>
    </div>
    <div>
        <button id="export-business-btn" class="btn btn-success">ğŸ“Š ë§¤ì¶œ ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°</button>
    </div>
</div>

<!-- ì›”ë³„/ê¸°ê°„ë³„ í•„í„° -->
<div class="month-filters">
    <button id="date-range-btn" class="btn btn-primary">ê¸°ê°„ ì„¤ì •</button>
    <a href="{{ url_for('business_dashboard') }}" class="btn {{ 'btn-active' if not selected_month and not start_date else 'btn-secondary' }}">ì „ì²´</a>
    
    {% for month in available_months %}
    <a href="{{ url_for('business_dashboard', month=month) }}" 
       class="btn {{ 'btn-active' if selected_month == month else 'btn-secondary' }}">{{ month }}</a>
    {% endfor %}
</div>

<!-- ê¸°ê°„ ì„¤ì • ëª¨ë‹¬ -->
<div id="date-range-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>ê¸°ê°„ ì„¤ì •</h3>
        <form action="{{ url_for('business_dashboard') }}" method="get" class="date-range-form">
            <div class="form-group">
                <label for="start_date">ì‹œì‘ì¼:</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}">
            </div>
            <div class="form-group">
                <label for="end_date">ì¢…ë£Œì¼:</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}">
            </div>
            <button type="submit" class="btn btn-primary">ì¡°íšŒ</button>
        </form>
    </div>
</div>

<!-- ìš”ì•½ ì¹´ë“œë“¤ -->
<div class="summary-cards">
    <div class="card" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
        <h3>ì´ ë§¤ì¶œ</h3>
        <p>{{ '{:,.0f}'.format(total_revenue) }} ì›</p>
    </div>
    <div class="card" style="background: linear-gradient(135deg, #00a6da, #0088b3); color: white;">
        <h3>ë§¤ì¶œ ì´ì´ìµ</h3>
        <p>{{ '{:,.0f}'.format(gross_profit) }} ì›</p>
    </div>

    {% if active_membership.role in ['owner', 'admin'] %}
    <div class="card" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #333;">
        <h3>ì´ ì§€ì¶œ</h3>
        <p>{{ '{:,.0f}'.format(total_expenses) }} ì›</p>
    </div>
    <div class="card" 
         style="background: {% if net_profit >= 0 %}linear-gradient(135deg, #6f42c1, #5a32a3){% else %}linear-gradient(135deg, #dc3545, #b02a37){% endif %}; color: white;">
        <h3>ìˆœì´ìµ</h3>
        <p>{{ '{:,.0f}'.format(net_profit) }} ì›</p>
    </div>
    {% endif %}
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="main-content">
    <!-- ìµœê·¼ ë§¤ì¶œ í˜„í™© -->
    <div class="card">
        <h3>ìµœê·¼ ë§¤ì¶œ í˜„í™©</h3>
        {% if recent_sales_data %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì œí’ˆëª…</th>
                        <th>íŒë§¤ì±„ë„</th>
                        <th>íŒë§¤ê°€</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ìˆœì´ìµ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in recent_sales_data %}
                    <tr>
                        <td>{{ sale['ë‚ ì§œ'].strftime('%Y-%m-%d') if sale['ë‚ ì§œ'].strftime else sale['ë‚ ì§œ'] }}</td>
                        <td>{{ sale['ì œí’ˆëª…'] }}</td>
                        <td>{{ sale['íŒë§¤ì±„ë„'] }}</td>
                        <td>{{ '{:,.0f}'.format(sale['íŒë§¤ê°€']) }} ì›</td>
                        <td>{{ sale['ìˆ˜ëŸ‰'] }}</td>
                        <td style="color: {% if sale['ìˆœì´ìµ'] >= 0 %}#28a745{% else %}#dc3545{% endif %}">
                            {{ '{:,.0f}'.format(sale['ìˆœì´ìµ']) }} ì›
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align: center; color: #888; padding: 40px;">
            {% if selected_month or start_date %}
            ì„ íƒëœ ê¸°ê°„ì— ë§¤ì¶œì´ ì—†ìŠµë‹ˆë‹¤.
            {% else %}
            ì•„ì§ ë“±ë¡ëœ ë§¤ì¶œì´ ì—†ìŠµë‹ˆë‹¤.
            {% endif %}
        </p>
        <div style="text-align: center;">
            <a href="{{ url_for('business_products') }}" class="btn btn-primary">ì œí’ˆ ë“±ë¡í•˜ê¸°</a>
            <a href="{{ url_for('business_sales') }}" class="btn btn-success" style="margin-left: 10px;">ë§¤ì¶œ ë“±ë¡í•˜ê¸°</a>
        </div>
        {% endif %}
    </div>
    
    <!-- ë‚ ì§œë³„ íŒë§¤í˜„í™© -->
    <div class="card">
        <h3>ë‚ ì§œë³„ íŒë§¤í˜„í™©</h3>
        {% if date_details %}
        <div class="category-buttons">
            {% for date in date_details.keys() %}
            <button class="category-btn date-btn" data-date="{{ date }}">{{ date }}</button>
            {% endfor %}
        </div>
        <div id="date-details-container">
            <p>ìœ„ ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ íŒë§¤ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        {% else %}
        <p style="text-align: center; color: #888; padding: 40px;">
            {% if selected_month or start_date %}
            ì„ íƒëœ ê¸°ê°„ì— ë§¤ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            {% else %}
            ì•„ì§ ë§¤ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            {% endif %}
        </p>
        {% endif %}
        
        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #444;">
            <h4>ë¹ ë¥¸ ì•¡ì…˜</h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <a href="{{ url_for('business_sales') }}" class="btn btn-success">ë§¤ì¶œ ë“±ë¡</a>
                <a href="{{ url_for('business_products') }}" class="btn btn-primary">ì œí’ˆ ê´€ë¦¬</a>
                <a href="{{ url_for('show_results') }}" class="btn btn-secondary">ì§€ì¶œ ë“±ë¡</a>
            </div>
        </div>
        
        {% if recent_sales_data %}
        <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 8px;">
            <h4 style="margin-bottom: 10px;">
                {% if selected_month %}{{ selected_month }} ìš”ì•½{% elif start_date and end_date %}{{ start_date }} ~ {{ end_date }} ìš”ì•½{% else %}ì „ì²´ ìš”ì•½{% endif %}
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <strong>ë§¤ì¶œì•¡:</strong> {{ '{:,.0f}'.format(total_revenue) }} ì›<br>
                    <strong>ë§¤ì¶œì´ìµ:</strong> {{ '{:,.0f}'.format(gross_profit) }} ì›
                </div>
                <div>
                    <strong>ì§€ì¶œì•¡:</strong> {{ '{:,.0f}'.format(total_expenses) }} ì›<br>
                    <strong>ìˆœì´ìµ:</strong> 
                    <span style="color: {% if net_profit >= 0 %}#28a745{% else %}#dc3545{% endif %}">
                        {{ '{:,.0f}'.format(net_profit) }} ì›
                    </span>
                </div>
            </div>
            
            {% if net_profit > 0 %}
            <div style="margin-top: 10px; padding: 10px; background: rgba(40, 167, 69, 0.2); border-radius: 4px; color: #28a745;">
                ìˆœì´ìµì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤! ìˆ˜ìµë¥ : {{ '{:.1f}'.format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%
            </div>
            {% elif net_profit < 0 %}
            <div style="margin-top: 10px; padding: 10px; background: rgba(220, 53, 69, 0.2); border-radius: 4px; color: #dc3545;">
                ì†ì‹¤ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì§€ì¶œ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
    .main-content {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 30px;
        align-items: start;
    }
    
    .month-filters {
        margin-bottom: 30px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .month-filters .btn {
        text-decoration: none;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; top: 0;
        width: 100%; height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.6);
    }
    
    .modal-content {
        background-color: var(--card-bg);
        margin: 15% auto;
        padding: 30px;
        border: 1px solid var(--border-color);
        width: 80%; max-width: 400px;
        border-radius: 12px;
        position: relative;
    }
    
    .close-button {
        color: #aaa;
        position: absolute;
        top: 15px; right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .date-range-form input[type="date"] {
        background-color: #3e3e3e;
        color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 8px;
        width: 100%;
    }
    
    .date-summary {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .date-summary:hover {
        background-color: #3e3e3e;
    }
    
    .date-summary td:first-child {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .arrow-icon {
        transition: transform 0.3s ease;
        font-size: 0.8em;
    }
    
    .arrow-icon.open {
        transform: rotate(180deg);
    }
    
    .date-details td {
        padding: 0 !important;
        border: none;
    }
    
    .table-nested {
        width: 100%;
        margin: 0;
        background-color: #3a3a3a;
    }
    
    .table-nested td {
        padding: 8px 25px;
        border: none;
    }
    
    .table-nested tr:not(:last-child) td {
        border-bottom: 1px solid #4f4f4f;
    }
    
    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ëª¨ë‹¬ ë¡œì§ ---
    const modal = document.getElementById("date-range-modal");
    const btn = document.getElementById("date-range-btn");
    const span = document.getElementsByClassName("close-button")[0];
    
    btn.onclick = function() {
        modal.style.display = "block";
    }
    
    span.onclick = function() {
        modal.style.display = "none";
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // --- ë‚ ì§œë³„ ìƒì„¸ ë‚´ì—­ í‘œì‹œ ë¡œì§ ---
    const dateDetails = {{ date_details | tojson }};
    const dateButtons = document.querySelectorAll('.date-btn');
    const detailsContainer = document.getElementById('date-details-container');
    
    dateButtons.forEach(button => {
        button.addEventListener('click', function() {
            const selectedDate = this.dataset.date;
            const dateData = dateDetails[selectedDate];
            
            detailsContainer.innerHTML = '';
            
            if (dateData && Object.keys(dateData.products).length > 0) {
                // ë‚ ì§œ ìš”ì•½ ì •ë³´
                const summaryDiv = document.createElement('div');
                summaryDiv.style.cssText = 'background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px;';
                summaryDiv.innerHTML = `
                    <h4 style="margin-bottom: 10px;">${selectedDate} íŒë§¤ ìš”ì•½</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>ì´ íŒë§¤ìˆ˜ëŸ‰:</strong> ${dateData.total_quantity}ê°œ<br>
                            <strong>ì´ ë§¤ì¶œì•¡:</strong> ${dateData.total_revenue.toLocaleString()}ì›
                        </div>
                        <div>
                            <strong>ì´ ìˆœì´ìµ:</strong> 
                            <span style="color: ${dateData.total_profit >= 0 ? '#28a745' : '#dc3545'}">
                                ${dateData.total_profit.toLocaleString()}ì›
                            </span>
                        </div>
                    </div>
                `;
                detailsContainer.appendChild(summaryDiv);
                
                // ì œí’ˆë³„ ìƒì„¸ í…Œì´ë¸”
                const table = document.createElement('table');
                table.className = 'table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>ì œí’ˆëª…</th>
                            <th>íŒë§¤ìˆ˜ëŸ‰</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ìˆœì´ìµ</th>
                        </tr>
                    </thead>
                `;
                const tbody = document.createElement('tbody');
                table.appendChild(tbody);
                
                for (const productName in dateData.products) {
                    const productData = dateData.products[productName];
                    
                    // ì œí’ˆ ìš”ì•½ í–‰
                    const summaryRow = tbody.insertRow();
                    summaryRow.className = 'date-summary';
                    summaryRow.innerHTML = `
                        <td>
                            <span>${productName}</span>
                            <span class="arrow-icon">â–¼</span>
                        </td>
                        <td>${productData.quantity}ê°œ</td>
                        <td>${productData.revenue.toLocaleString()}ì›</td>
                        <td style="color: ${productData.profit >= 0 ? '#28a745' : '#dc3545'}">
                            ${productData.profit.toLocaleString()}ì›
                        </td>
                    `;
                    
                    // ìƒì„¸ í–‰ (ê°œë³„ íŒë§¤ ê¸°ë¡)
                    const detailsRow = tbody.insertRow();
                    detailsRow.className = 'date-details';
                    detailsRow.style.display = 'none';
                    const detailsCell = detailsRow.insertCell();
                    detailsCell.colSpan = 4;
                    
                    let detailsHtml = '<table class="table-nested"><tbody>';
                    productData.sales.forEach(sale => {
                        detailsHtml += `
                            <tr>
                                <td>${sale['íŒë§¤ì±„ë„']}</td>
                                <td>íŒë§¤ê°€: ${sale['íŒë§¤ê°€'].toLocaleString()}ì›</td>
                                <td>ìˆ˜ëŸ‰: ${sale['ìˆ˜ëŸ‰']}ê°œ</td>
                                <td style="color: ${sale['ìˆœì´ìµ'] >= 0 ? '#28a745' : '#dc3545'}">
                                    ìˆœì´ìµ: ${sale['ìˆœì´ìµ'].toLocaleString()}ì›
                                </td>
                            </tr>
                        `;
                    });
                    detailsHtml += '</tbody></table>';
                    detailsCell.innerHTML = detailsHtml;
                    
                    // í´ë¦­ ì´ë²¤íŠ¸
                    summaryRow.addEventListener('click', () => {
                        const isVisible = detailsRow.style.display === 'table-row';
                        detailsRow.style.display = isVisible ? 'none' : 'table-row';
                        summaryRow.querySelector('.arrow-icon').classList.toggle('open');
                    });
                }
                
                detailsContainer.appendChild(table);
            } else {
                detailsContainer.innerHTML = `<p>${selectedDate}ì— íŒë§¤ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            dateButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
    document.getElementById('export-business-btn').addEventListener('click', function() {
        const month = '{{ selected_month or "" }}';
        const startDate = '{{ start_date or "" }}';
        const endDate = '{{ end_date or "" }}';
        
        let url = '/business/export';
        const params = new URLSearchParams();
        
        if (startDate && endDate) {
            params.append('start_date', startDate);
            params.append('end_date', endDate);
        } else if (month) {
            params.append('month', month);
        }
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.location.href = url;
    });
});
</script>
{% endblock %}