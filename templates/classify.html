{% extends "layout.html" %}

{% block title %}거래내역 분류{% endblock %}

{% block content %}
<style>
    /* 버튼 필터를 위한 스타일 */
    .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    .filter-group-title {
        font-weight: bold;
        margin-right: 15px;
        font-size: 1.1em;
    }
</style>

<div class="header">
    <h1>거래내역 분류</h1>
    <p>엑셀 파일을 업로드하여 거래내역을 추가하거나, 기존 내역을 관리하세요.</p>
</div>

<div class="card">
    <h3>새 거래내역 업로드</h3>
    <form method="POST" action="{{ url_for('show_results') }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">엑셀(xlsx) 또는 CSV 파일</label>
            <input type="file" name="file" id="file" class="form-control" accept=".xlsx, .csv">
        </div>
        
        <div class="form-group" style="display: flex; gap: 10px; margin-top: 1.5rem;">
            <button type="submit" name="action" value="append" class="btn btn-success">파일 추가</button>
            <button type="submit" name="action" value="upload" class="btn btn-danger" 
                    onclick="return confirm('정말 기존의 모든 데이터를 삭제하고 새로 업로드하시겠습니까? 이 작업은 되돌릴 수 없습니다.');">
                전체 삭제
            </button>
        </div>
    </form>
</div>

<div class="card mt-4">
    <h3>거래내역 목록</h3>

    <div style="margin-bottom: 1.5rem;">
        <div class="filter-group" style="margin-bottom: 15px;">
            <span class="filter-group-title">월별:</span>
            <a href="{{ url_for('show_results', category_filter=active_filter) }}" class="btn btn-sm {{ 'btn-active' if not selected_month else 'btn-secondary' }}">전체</a>
            {% for month in available_months %}
            <a href="{{ url_for('show_results', month_filter=month, category_filter=active_filter) }}" class="btn btn-sm {{ 'btn-active' if month == selected_month else 'btn-secondary' }}">{{ month }}</a>
            {% endfor %}
        </div>
        <div class="filter-group">
            <span class="filter-group-title">카테고리:</span>
            <a href="{{ url_for('show_results', month_filter=selected_month) }}" class="btn btn-sm {{ 'btn-active' if not active_filter else 'btn-secondary' }}">전체</a>
            {% for category in unique_categories %}
            <a href="{{ url_for('show_results', month_filter=selected_month, category_filter=category) }}" class="btn btn-sm {{ 'btn-active' if category == active_filter else 'btn-secondary' }}">{{ category }}</a>
            {% endfor %}
        </div>
    </div>

    <div class="table-responsive" style="margin-top: 20px;">
        <table class="table">
            <thead>
                <tr>
                    <th>날짜</th>
                    <th>거래처명</th>
                    <th>금액</th>
                    <th>카테고리</th>
                    <th style="text-align: right;">관리</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr id="record-{{ record.id }}">
                    <td data-label="날짜">{{ record['날짜'] }}</td>
                    <td data-label="거래처명">{{ record['거래처명'] }}</td>
                    <td data-label="금액">{{ '{:,.0f}'.format(record['금액']) }} 원</td>
                    <td data-label="카테고리">{{ record['카테고리'] }}</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button class="btn btn-primary btn-sm edit-btn"
                                data-id="{{ record.id }}"
                                data-date="{{ record['날짜'] }}"
                                data-merchant="{{ record['거래처명'] }}"
                                data-amount="{{ record['금액'] }}"
                                data-category="{{ record['카테고리'] }}">
                            수정
                        </button>
                        <form action="{{ url_for('delete_item', item_id=record.id) }}" method="post" style="display: inline-block; margin-left: 5px;">
                            <input type="hidden" name="month_filter" value="{{ selected_month or '' }}">
                            <input type="hidden" name="category_filter" value="{{ active_filter or '' }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('정말 이 항목을 삭제하시겠습니까?');">삭제</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">표시할 데이터가 없습니다.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>거래내역 수정</h3>
        <form id="edit-form" method="POST">
            <input type="hidden" name="month_filter" value="{{ selected_month or '' }}">
            <input type="hidden" name="category_filter" value="{{ active_filter or '' }}">
            <div class="form-group">
                <label for="edit-date">날짜</label>
                <input type="date" id="edit-date" name="date" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-merchant">거래처명</label>
                <input type="text" id="edit-merchant" name="merchant" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-amount">금액</label>
                <input type="number" id="edit-amount" name="amount" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-category">카테고리</label>
                <input type="text" id="edit-category" name="category" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">저장</button>
        </form>
    </div>
</div>

<style>
    .btn-sm { padding: 5px 10px; font-size: 0.9em; }
    .modal {
        display: none; position: fixed; z-index: 1000;
        left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
        background-color: var(--card-bg); margin: 10% auto;
        padding: 30px; border: 1px solid var(--border-color);
        width: 90%; max-width: 500px; border-radius: 12px;
        position: relative;
    }
    .close-button {
        color: #aaa; position: absolute; top: 15px; right: 25px;
        font-size: 28px; font-weight: bold; cursor: pointer;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('edit-modal');
    const closeButton = document.querySelector('.close-button');
    const editForm = document.getElementById('edit-form');
    
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const date = this.dataset.date;
            const merchant = this.dataset.merchant;
            const amount = this.dataset.amount;
            const category = this.dataset.category;

            editForm.action = `/edit_transaction/${id}`;

            document.getElementById('edit-date').value = date;
            document.getElementById('edit-merchant').value = merchant;
            document.getElementById('edit-amount').value = amount;
            document.getElementById('edit-category').value = category;

            modal.style.display = 'block';
        });
    });

    closeButton.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
});
</script>
{% endblock %}