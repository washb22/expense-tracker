{% extends "layout.html" %}

{% block title %}ê±°ë˜ë‚´ì—­ ë¶„ë¥˜{% endblock %}

{% block content %}
<style>
    /* íŒŒì¼ ì—…ë¡œë“œ ê°€ì´ë“œ ìŠ¤íƒ€ì¼ */
    .excel-example {
        background-color: #f8f9fa;
        color: #333;
        border-radius: 8px;
        overflow: hidden;
        margin: 15px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .excel-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 12px;
        font-weight: bold;
        text-align: center;
    }
    .excel-table {
        width: 100%;
        border-collapse: collapse;
    }
    .excel-table th {
        background-color: #e9ecef;
        padding: 12px;
        text-align: center;
        border-right: 1px solid #dee2e6;
        font-weight: bold;
        color: #495057;
    }
    .excel-table th:last-child { border-right: none; }
    .excel-table td {
        padding: 10px;
        text-align: center;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        background-color: #ffffff;
        color: #333;
    }
    .excel-table td:last-child { border-right: none; }
    .format-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    .format-tag {
        background-color: rgba(0, 166, 218, 0.2);
        color: #00a6da;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        border: 1px solid #00a6da;
    }
    .warning-list {
        list-style: none;
        padding: 0;
        margin: 15px 0;
    }
    .warning-list li {
        margin: 8px 0;
        padding: 12px;
        background-color: rgba(255,193,7,0.1);
        border-radius: 6px;
        border-left: 3px solid #ffc107;
        color: #333;
    }
    .code {
        background-color: rgba(255,255,255,0.2);
        padding: 3px 8px;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
    }
    .alert-info-custom {
        background: linear-gradient(135deg, #2c5aa0, #1e3a5f);
        border-left: 4px solid #00a6da;
        color: white;
    }
    .alert-warning-custom {
        background: linear-gradient(135deg, #d4a743, #b8941e);
        color: #1e1e1e;
        border-left: 4px solid #ffc107;
    }
    /* ë²„íŠ¼ í•„í„°ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
    .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    .filter-group-title {
        font-weight: bold;
        margin-right: 15px;
        font-size: 1.1em;
    }
    .btn-sm { padding: 5px 10px; font-size: 0.9em; }
    .modal {
        display: none; position: fixed; z-index: 1000;
        left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
        background-color: var(--card-bg); margin: 10% auto;
        padding: 30px; border: 1px solid var(--border-color);
        width: 90%; max-width: 500px; border-radius: 12px;
        position: relative;
    }
    .close-button {
        color: #aaa; position: absolute; top: 15px; right: 25px;
        font-size: 28px; font-weight: bold; cursor: pointer;
    }
</style>

<div class="header">
    <h1>ê±°ë˜ë‚´ì—­ ë¶„ë¥˜</h1>
    <p>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ê±°ë˜ë‚´ì—­ì„ ì¶”ê°€í•˜ê±°ë‚˜, ê¸°ì¡´ ë‚´ì—­ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
</div>

<div class="card">
    <h3>ìƒˆ ê±°ë˜ë‚´ì—­ ì—…ë¡œë“œ</h3>
    
    <!-- íŒŒì¼ í˜•ì‹ ì•ˆë‚´ -->
    <div class="alert alert-info-custom" style="padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 1.2em; margin-right: 8px;">ğŸ“‹</span>
            <strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹ ì•ˆë‚´</strong>
        </div>
        
        <div class="excel-example">
            <div class="excel-header">Excel íŒŒì¼ ì˜ˆì‹œ</div>
            <table class="excel-table">
                <thead>
                    <tr>
                        <th>ê±°ë˜ì¼ì‹œ</th>
                        <th>ê±°ë˜ì²˜</th>
                        <th>ì¶œê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>2025-01-15</td>
                        <td>ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì </td>
                        <td>4500</td>
                    </tr>
                    <tr>
                        <td>2025-01-16</td>
                        <td>GS25 í¸ì˜ì </td>
                        <td>12000</td>
                    </tr>
                    <tr>
                        <td>2025-01-17</td>
                        <td>ë§¥ë„ë‚ ë“œ</td>
                        <td>8900</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 15px;">
            <strong>ì¸ì‹ ê°€ëŠ¥í•œ ì—´ ì œëª©ë“¤:</strong>
            <div class="format-options">
                <span class="format-tag">ê±°ë˜ì¼ì‹œ</span>
                <span class="format-tag">ê±°ë˜ì¼ì</span>
                <span class="format-tag">ì‚¬ìš©ì¼</span>
                <span class="format-tag">ê±°ë˜ì²˜</span>
                <span class="format-tag">ê±°ë˜ë‚´ìš©</span>
                <span class="format-tag">ê°€ë§¹ì ëª…</span>
                <span class="format-tag">ì¶œê¸ˆì•¡</span>
                <span class="format-tag">ì‚¬ìš©ê¸ˆì•¡</span>
                <span class="format-tag">ê±°ë˜ê¸ˆì•¡</span>
            </div>
        </div>
    </div>

    <!-- ì£¼ì˜ì‚¬í•­ -->
    <div class="alert alert-warning-custom" style="padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 1.2em; margin-right: 8px;">âš ï¸</span>
            <strong>ì—…ë¡œë“œ ì „ í™•ì¸ì‚¬í•­</strong>
        </div>
        
        <ul class="warning-list">
            <li>
                <strong>ë‚ ì§œ í˜•ì‹:</strong> 
                <span class="code">YYYY-MM-DD</span> ë˜ëŠ” 
                <span class="code">YYYY/MM/DD</span> í˜•íƒœë¡œ ì…ë ¥
                <br><small>ì˜ˆ: 2025-01-15, 2025/01/15</small>
            </li>
            <li>
                <strong>ê¸ˆì•¡ ì…ë ¥:</strong> 
                ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš” (ì½¤ë§ˆ ìˆì–´ë„ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤)
                <br><small>ì˜ˆ: 4500, 12,000, 1234567</small>
            </li>
            <li>
                <strong>í—¤ë” í•„ìˆ˜:</strong> 
                ì²« ë²ˆì§¸ í–‰ì€ ë°˜ë“œì‹œ ì—´ ì œëª©ì´ì–´ì•¼ í•©ë‹ˆë‹¤
            </li>
            <li>
                <strong>íŒŒì¼ í˜•ì‹:</strong> 
                Excel (.xlsx) ë˜ëŠ” CSV (.csv) íŒŒì¼ë§Œ ì§€ì›
            </li>
        </ul>
    </div>
    
    <form method="POST" action="{{ url_for('show_results') }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">ì—‘ì…€(xlsx) ë˜ëŠ” CSV íŒŒì¼</label>
            <input type="file" name="file" id="file" class="form-control" accept=".xlsx, .csv">
        </div>
        
        <div class="form-group" style="display: flex; gap: 10px; margin-top: 1.5rem;">
            <button type="submit" name="action" value="append" class="btn btn-success">íŒŒì¼ ì¶”ê°€</button>
            <button type="submit" name="action" value="upload" class="btn btn-danger" 
                    onclick="return confirm('ì •ë§ ê¸°ì¡´ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                ì „ì²´ ì‚­ì œ
            </button>
        </div>
    </form>
</div>

<div class="card mt-4">
    <h3>ê±°ë˜ë‚´ì—­ ëª©ë¡</h3>

    <div style="margin-bottom: 1.5rem;">
        <div class="filter-group" style="margin-bottom: 15px;">
            <span class="filter-group-title">ì›”ë³„:</span>
            <a href="{{ url_for('show_results', category_filter=active_filter) }}" class="btn btn-sm {{ 'btn-active' if not selected_month else 'btn-secondary' }}">ì „ì²´</a>
            {% for month in available_months %}
            <a href="{{ url_for('show_results', month_filter=month, category_filter=active_filter) }}" class="btn btn-sm {{ 'btn-active' if month == selected_month else 'btn-secondary' }}">{{ month }}</a>
            {% endfor %}
        </div>
        <div class="filter-group">
            <span class="filter-group-title">ì¹´í…Œê³ ë¦¬:</span>
            <a href="{{ url_for('show_results', month_filter=selected_month) }}" class="btn btn-sm {{ 'btn-active' if not active_filter else 'btn-secondary' }}">ì „ì²´</a>
            {% for category in unique_categories %}
            <a href="{{ url_for('show_results', month_filter=selected_month, category_filter=category) }}" class="btn btn-sm {{ 'btn-active' if category == active_filter else 'btn-secondary' }}">{{ category }}</a>
            {% endfor %}
        </div>
    </div>

    <div class="table-responsive" style="margin-top: 20px;">
        <table class="table">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ê±°ë˜ì²˜ëª…</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                    <th style="text-align: right;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr id="record-{{ record.id }}">
                    <td data-label="ë‚ ì§œ">{{ record['ë‚ ì§œ'] }}</td>
                    <td data-label="ê±°ë˜ì²˜ëª…">{{ record['ê±°ë˜ì²˜ëª…'] }}</td>
                    <td data-label="ê¸ˆì•¡">{{ '{:,.0f}'.format(record['ê¸ˆì•¡']) }} ì›</td>
                    <td data-label="ì¹´í…Œê³ ë¦¬">{{ record['ì¹´í…Œê³ ë¦¬'] }}</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button class="btn btn-primary btn-sm edit-btn"
                                data-id="{{ record.id }}"
                                data-date="{{ record['ë‚ ì§œ'] }}"
                                data-merchant="{{ record['ê±°ë˜ì²˜ëª…'] }}"
                                data-amount="{{ record['ê¸ˆì•¡'] }}"
                                data-category="{{ record['ì¹´í…Œê³ ë¦¬'] }}">
                            ìˆ˜ì •
                        </button>
                        <form action="{{ url_for('delete_item', item_id=record.id) }}" method="post" style="display: inline-block; margin-left: 5px;">
                            <input type="hidden" name="month_filter" value="{{ selected_month or '' }}">
                            <input type="hidden" name="category_filter" value="{{ active_filter or '' }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ì •ë§ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>ê±°ë˜ë‚´ì—­ ìˆ˜ì •</h3>
        <form id="edit-form" method="POST">
            <input type="hidden" name="month_filter" value="{{ selected_month or '' }}">
            <input type="hidden" name="category_filter" value="{{ active_filter or '' }}">
            <div class="form-group">
                <label for="edit-date">ë‚ ì§œ</label>
                <input type="date" id="edit-date" name="date" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-merchant">ê±°ë˜ì²˜ëª…</label>
                <input type="text" id="edit-merchant" name="merchant" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-amount">ê¸ˆì•¡</label>
                <input type="number" id="edit-amount" name="amount" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-category">ì¹´í…Œê³ ë¦¬</label>
                <input type="text" id="edit-category" name="category" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('edit-modal');
    const closeButton = document.querySelector('.close-button');
    const editForm = document.getElementById('edit-form');
    
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const date = this.dataset.date;
            const merchant = this.dataset.merchant;
            const amount = this.dataset.amount;
            const category = this.dataset.category;

            editForm.action = `/edit_transaction/${id}`;

            document.getElementById('edit-date').value = date;
            document.getElementById('edit-merchant').value = merchant;
            document.getElementById('edit-amount').value = amount;
            document.getElementById('edit-category').value = category;

            modal.style.display = 'block';
        });
    });

    closeButton.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
});
</script>
{% endblock %}