{% extends "layout.html" %}

{% block title %}ê±°ë˜ë‚´ì—­ ë¶„ë¥˜{% endblock %}

{% block content %}
<style>
    /* íŒŒì¼ ì—…ë¡œë“œ ê°€ì´ë“œ ìŠ¤íƒ€ì¼ */
    .excel-example {
        background-color: #f8f9fa;
        color: #333;
        border-radius: 8px;
        overflow: hidden;
        margin: 15px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .excel-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 12px;
        font-weight: bold;
        text-align: center;
    }
    .excel-table {
        width: 100%;
        border-collapse: collapse;
    }
    .excel-table th {
        background-color: #e9ecef;
        padding: 12px;
        text-align: center;
        border-right: 1px solid #dee2e6;
        font-weight: bold;
        color: #495057;
    }
    .excel-table th:last-child { border-right: none; }
    .excel-table td {
        padding: 10px;
        text-align: center;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        background-color: #ffffff;
        color: #333;
    }
    .excel-table td:last-child { border-right: none; }
    .format-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    .format-tag {
        background-color: rgba(0, 166, 218, 0.2);
        color: #00a6da;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        border: 1px solid #00a6da;
    }
    .warning-list {
        list-style: none;
        padding: 0;
        margin: 15px 0;
    }
    .warning-list li {
        margin: 8px 0;
        padding: 12px;
        background-color: rgba(255,193,7,0.1);
        border-radius: 6px;
        border-left: 3px solid #ffc107;
        color: #333;
    }
    .code {
        background-color: rgba(255,255,255,0.2);
        padding: 3px 8px;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
    }
    .alert-info-custom {
        background: linear-gradient(135deg, #2c5aa0, #1e3a5f);
        border-left: 4px solid #00a6da;
        color: white;
    }
    .alert-warning-custom {
        background: linear-gradient(135deg, #d4a743, #b8941e);
        color: #1e1e1e;
        border-left: 4px solid #ffc107;
    }
    /* ë²„íŠ¼ í•„í„°ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
    .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    .filter-group-title {
        font-weight: bold;
        margin-right: 15px;
        font-size: 1.1em;
    }
    .btn-sm { padding: 5px 10px; font-size: 0.9em; }
    .modal {
        display: none; position: fixed; z-index: 1000;
        left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
        background-color: var(--card-bg); margin: 10% auto;
        padding: 30px; border: 1px solid var(--border-color);
        width: 90%; max-width: 500px; border-radius: 12px;
        position: relative;
    }
    .close-button {
        color: #aaa; position: absolute; top: 15px; right: 25px;
        font-size: 28px; font-weight: bold; cursor: pointer;
    }
    /* ì•Œë¦¼ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }
    .toast-notification.show {
        opacity: 1;
        transform: translateX(0);
    }
    .toast-success {
        background-color: #28a745;
    }
    .toast-error {
        background-color: #dc3545;
    }
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .loading-spinner {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #00a6da;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>

<div class="header">
    <h1>ê±°ë˜ë‚´ì—­ ë¶„ë¥˜</h1>
    <p>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ê±°ë˜ë‚´ì—­ì„ ì¶”ê°€í•˜ê±°ë‚˜, ê¸°ì¡´ ë‚´ì—­ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
</div>

<div class="card">
    <h3>ìƒˆ ê±°ë˜ë‚´ì—­ ì—…ë¡œë“œ</h3>
    
    <!-- íŒŒì¼ í˜•ì‹ ì•ˆë‚´ -->
    <div class="alert alert-info-custom" style="padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 1.2em; margin-right: 8px;">ğŸ“‹</span>
            <strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹ ì•ˆë‚´</strong>
        </div>
        
        <div class="excel-example">
            <div class="excel-header">Excel íŒŒì¼ ì˜ˆì‹œ</div>
            <table class="excel-table">
                <thead>
                    <tr>
                        <th>ê±°ë˜ì¼ì‹œ</th>
                        <th>ê±°ë˜ì²˜</th>
                        <th>ì¶œê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>2025-01-15</td>
                        <td>ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì </td>
                        <td>4500</td>
                    </tr>
                    <tr>
                        <td>2025-01-16</td>
                        <td>GS25 í¸ì˜ì </td>
                        <td>12000</td>
                    </tr>
                    <tr>
                        <td>2025-01-17</td>
                        <td>ë§¥ë„ë‚ ë“œ</td>
                        <td>8900</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 15px;">
            <strong>ì¸ì‹ ê°€ëŠ¥í•œ ì—´ ì œëª©ë“¤:</strong>
            <div class="format-options">
                <span class="format-tag">ê±°ë˜ì¼ì‹œ</span>
                <span class="format-tag">ê±°ë˜ì¼ì</span>
                <span class="format-tag">ì‚¬ìš©ì¼</span>
                <span class="format-tag">ê±°ë˜ì²˜</span>
                <span class="format-tag">ê±°ë˜ë‚´ìš©</span>
                <span class="format-tag">ê°€ë§¹ì ëª…</span>
                <span class="format-tag">ì¶œê¸ˆì•¡</span>
                <span class="format-tag">ì‚¬ìš©ê¸ˆì•¡</span>
                <span class="format-tag">ê±°ë˜ê¸ˆì•¡</span>
            </div>
        </div>
    </div>

    <!-- ì£¼ì˜ì‚¬í•­ -->
    <div class="alert alert-warning-custom" style="padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 1.2em; margin-right: 8px;">âš ï¸</span>
            <strong>ì—…ë¡œë“œ ì „ í™•ì¸ì‚¬í•­</strong>
        </div>
        
        <ul class="warning-list">
            <li>
                <strong>ë‚ ì§œ í˜•ì‹:</strong> 
                <span class="code">YYYY-MM-DD</span> ë˜ëŠ” 
                <span class="code">YYYY/MM/DD</span> í˜•íƒœë¡œ ì…ë ¥
                <br><small>ì˜ˆ: 2025-01-15, 2025/01/15</small>
            </li>
            <li>
                <strong>ê¸ˆì•¡ ì…ë ¥:</strong> 
                ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš” (ì½¤ë§ˆ ìˆì–´ë„ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤)
                <br><small>ì˜ˆ: 4500, 12,000, 1234567</small>
            </li>
            <li>
                <strong>í—¤ë” í•„ìˆ˜:</strong> 
                ì²« ë²ˆì§¸ í–‰ì€ ë°˜ë“œì‹œ ì—´ ì œëª©ì´ì–´ì•¼ í•©ë‹ˆë‹¤
            </li>
            <li>
                <strong>íŒŒì¼ í˜•ì‹:</strong> 
                Excel (.xlsx) ë˜ëŠ” CSV (.csv) íŒŒì¼ë§Œ ì§€ì›
            </li>
        </ul>
    </div>
    
    <form method="POST" action="{{ url_for('show_results') }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">ì—‘ì…€(xlsx) ë˜ëŠ” CSV íŒŒì¼</label>
            <input type="file" name="file" id="file" class="form-control" accept=".xlsx, .csv">
        </div>
        
        <div class="form-group" style="display: flex; gap: 10px; margin-top: 1.5rem;">
            <button type="submit" name="action" value="append" class="btn btn-success">íŒŒì¼ ì¶”ê°€</button>
            <button type="submit" name="action" value="upload" class="btn btn-danger" 
                    onclick="return confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆ íŒŒì¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                ì „ì²´ êµì²´
            </button>
        </div>
    </form>
</div>

<div class="card mt-4">
    <h3>ê±°ë˜ë‚´ì—­ ëª©ë¡</h3>

    <div style="margin-bottom: 1.5rem;">
        <div class="filter-group" style="margin-bottom: 15px;">
            <span class="filter-group-title">ì›”ë³„:</span>
            <button class="btn btn-sm filter-btn month-filter {{ 'btn-active' if not selected_month else 'btn-secondary' }}" 
                    data-type="month" data-value="">ì „ì²´</button>
            {% for month in available_months %}
            <button class="btn btn-sm filter-btn month-filter {{ 'btn-active' if month == selected_month else 'btn-secondary' }}" 
                    data-type="month" data-value="{{ month }}">{{ month }}</button>
            {% endfor %}
        </div>
        <div class="filter-group">
            <span class="filter-group-title">ì¹´í…Œê³ ë¦¬:</span>
            <button class="btn btn-sm filter-btn category-filter {{ 'btn-active' if not active_filter else 'btn-secondary' }}" 
                    data-type="category" data-value="">ì „ì²´</button>
            {% for category in unique_categories %}
            <button class="btn btn-sm filter-btn category-filter {{ 'btn-active' if category == active_filter else 'btn-secondary' }}" 
                    data-type="category" data-value="{{ category }}">{{ category }}</button>
            {% endfor %}
        </div>
    </div>

    <!-- ì „ì²´ì„ íƒ/ì„ íƒì‚­ì œ ë²„íŠ¼ ì¶”ê°€ (í…Œì´ë¸” ìœ„ì—) -->
    <div style="margin-bottom: 15px;">
        <button type="button" id="select-all-btn" class="btn btn-secondary btn-sm">ì „ì²´ì„ íƒ</button>
        <button type="button" id="delete-selected-btn" class="btn btn-danger btn-sm" style="margin-left: 10px;">ì„ íƒì‚­ì œ</button>
        <span id="selected-count" style="margin-left: 15px; color: #ccc;">ì„ íƒëœ í•­ëª©: 0ê°œ</span>
    </div>

    <div id="table-container">
        <div class="table-responsive" style="margin-top: 20px;">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="master-checkbox">
                        </th>
                        <th>ë‚ ì§œ</th>
                        <th>ê±°ë˜ì²˜ëª…</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th style="text-align: right;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="records-tbody">
                    {% for record in records %}
                    <tr id="record-{{ record.id }}">
                        <td>
                            <input type="checkbox" class="record-checkbox" value="{{ record.id }}">
                        </td>
                        <td data-label="ë‚ ì§œ">{{ record['ë‚ ì§œ'] }}</td>
                        <td data-label="ê±°ë˜ì²˜ëª…">{{ record['ê±°ë˜ì²˜ëª…'] }}</td>
                        <td data-label="ê¸ˆì•¡">{{ '{:,.0f}'.format(record['ê¸ˆì•¡']) }} ì›</td>
                        <td data-label="ì¹´í…Œê³ ë¦¬">{{ record['ì¹´í…Œê³ ë¦¬'] }}</td>
                        <td style="text-align: right; white-space: nowrap;">
                            <button class="btn btn-primary btn-sm edit-btn"
                                    data-id="{{ record.id }}"
                                    data-date="{{ record['ë‚ ì§œ'] }}"
                                    data-merchant="{{ record['ê±°ë˜ì²˜ëª…'] }}"
                                    data-amount="{{ record['ê¸ˆì•¡'] }}"
                                    data-category="{{ record['ì¹´í…Œê³ ë¦¬'] }}">
                                ìˆ˜ì •
                            </button>
                            <button class="btn btn-danger btn-sm single-delete-btn" 
                                    data-id="{{ record.id }}"
                                    data-month="{{ selected_month or '' }}"
                                    data-category="{{ active_filter or '' }}"
                                    style="margin-left: 5px;">
                                ì‚­ì œ
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>ê±°ë˜ë‚´ì—­ ìˆ˜ì •</h3>
        <form id="edit-form" method="POST">
            <input type="hidden" name="month_filter" value="{{ selected_month or '' }}">
            <input type="hidden" name="category_filter" value="{{ active_filter or '' }}">
            <div class="form-group">
                <label for="edit-date">ë‚ ì§œ</label>
                <input type="date" id="edit-date" name="date" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-merchant">ê±°ë˜ì²˜ëª…</label>
                <input type="text" id="edit-merchant" name="merchant" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-amount">ê¸ˆì•¡</label>
                <input type="number" id="edit-amount" name="amount" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-category">ì¹´í…Œê³ ë¦¬</label>
                <input type="text" id="edit-category" name="category" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
        </form>
    </div>
</div>

<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div id="loading-spinner" class="loading-spinner"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentMonthFilter = '{{ selected_month or "" }}';
    let currentCategoryFilter = '{{ active_filter or "" }}';

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ë¡œë”© ìŠ¤í”¼ë„ˆ í•¨ìˆ˜
    function showLoading() {
        document.getElementById('loading-spinner').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loading-spinner').style.display = 'none';
    }

    // í•„í„° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
    function handleFilterClick(button) {
        const filterType = button.dataset.type;
        const filterValue = button.dataset.value;

        // í˜„ì¬ í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
        if (filterType === 'month') {
            currentMonthFilter = filterValue;
        } else if (filterType === 'category') {
            currentCategoryFilter = filterValue;
        }

        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        if (filterType === 'month') {
            document.querySelectorAll('.month-filter').forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-secondary');
            });
        } else {
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-secondary');
            });
        }
        
        button.classList.remove('btn-secondary');
        button.classList.add('btn-active');

        // AJAXë¡œ í•„í„°ë§ëœ ë°ì´í„° ë¡œë“œ
        loadFilteredData();
    }

    // í•„í„°ë§ëœ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    function loadFilteredData() {
        showLoading();
        
        const url = new URL('/classify', window.location.origin);
        if (currentMonthFilter) url.searchParams.set('month_filter', currentMonthFilter);
        if (currentCategoryFilter) url.searchParams.set('category_filter', currentCategoryFilter);

        fetch(url)
            .then(response => response.text())
            .then(html => {
                // ìƒˆ HTMLì—ì„œ í…Œì´ë¸” ë¶€ë¶„ë§Œ ì¶”ì¶œ
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTbody = doc.querySelector('#records-tbody');
                
                if (newTbody) {
                    document.querySelector('#records-tbody').innerHTML = newTbody.innerHTML;
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ë°”ì¸ë”©
                    bindEventListeners();
                    updateSelectedCount();
                }
                hideLoading();
            })
            .catch(error => {
                hideLoading();
                showToast('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”© í•¨ìˆ˜
    function bindEventListeners() {
        // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const date = this.dataset.date;
                const merchant = this.dataset.merchant;
                const amount = this.dataset.amount;
                const category = this.dataset.category;

                document.getElementById('edit-form').action = `/edit_transaction/${id}`;
                document.getElementById('edit-date').value = date;
                document.getElementById('edit-merchant').value = merchant;
                document.getElementById('edit-amount').value = amount;
                document.getElementById('edit-category').value = category;

                document.getElementById('edit-modal').style.display = 'block';
            });
        });

        // ê°œë³„ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.single-delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (!confirm('ì •ë§ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                const itemId = this.dataset.id;
                fetch(`/delete_item/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `month_filter=${currentMonthFilter}&category_filter=${currentCategoryFilter}`
                })
                .then(response => {
                    if (response.ok) {
                        const row = document.getElementById(`record-${itemId}`);
                        if (row) row.remove();
                        updateSelectedCount();
                        showToast('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                })
                .catch(error => {
                    showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            });
        });

        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        const recordCheckboxes = document.querySelectorAll('.record-checkbox');
        recordCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allChecked = Array.from(recordCheckboxes).every(cb => cb.checked);
                const anyChecked = Array.from(recordCheckboxes).some(cb => cb.checked);
                
                const masterCheckbox = document.getElementById('master-checkbox');
                if (masterCheckbox) {
                    masterCheckbox.checked = allChecked;
                    masterCheckbox.indeterminate = anyChecked && !allChecked;
                }
                updateSelectedCount();
            });
        });
    }

    // ì„ íƒëœ í•­ëª© ìˆ˜ ì—…ë°ì´íŠ¸
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
        document.getElementById('selected-count').textContent = `ì„ íƒëœ í•­ëª©: ${checkedBoxes.length}ê°œ`;
        document.getElementById('delete-selected-btn').disabled = checkedBoxes.length === 0;
    }

    // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // í•„í„° ë²„íŠ¼ë“¤
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            handleFilterClick(this);
        });
    });

    // ê¸°ì¡´ ìˆ˜ì • ëª¨ë‹¬ ê¸°ëŠ¥
    const modal = document.getElementById('edit-modal');
    const closeButton = document.querySelector('.close-button');

    closeButton.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // ë§ˆìŠ¤í„° ì²´í¬ë°•ìŠ¤
    const masterCheckbox = document.getElementById('master-checkbox');
    if (masterCheckbox) {
        masterCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }

    // ì „ì²´ì„ íƒ ë²„íŠ¼
    document.getElementById('select-all-btn').addEventListener('click', function() {
        const recordCheckboxes = document.querySelectorAll('.record-checkbox');
        const allChecked = Array.from(recordCheckboxes).every(cb => cb.checked);
        recordCheckboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });
        if (masterCheckbox) {
            masterCheckbox.checked = !allChecked;
            masterCheckbox.indeterminate = false;
        }
        updateSelectedCount();
        this.textContent = allChecked ? 'ì „ì²´ì„ íƒ' : 'ì„ íƒí•´ì œ';
    });

    // ì„ íƒì‚­ì œ ë²„íŠ¼
    document.getElementById('delete-selected-btn').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm(`ì„ íƒí•œ ${checkedBoxes.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
        
        fetch('/delete_multiple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ids: idsToDelete,
                month_filter: currentMonthFilter,
                category_filter: currentCategoryFilter
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                idsToDelete.forEach(id => {
                    const row = document.getElementById(`record-${id}`);
                    if (row) row.remove();
                });
                updateSelectedCount();
                showToast(`${idsToDelete.length}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        });
    });

    // ì´ˆê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° ìƒíƒœ ì„¤ì •
    bindEventListeners();
    updateSelectedCount();
});
</script>
{% endblock %}