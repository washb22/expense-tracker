{% extends "layout.html" %}

{% block title %}제품 관리{% endblock %}

{% block content %}
<div class="header">
    <h1>제품 관리</h1>
    <p>판매할 제품과 판매채널을 등록하고 관리하세요.</p>
</div>

<!-- 제품 등록 -->
<div class="card">
    <h3>새 제품 등록</h3>
    <form method="POST" action="{{ url_for('add_product') }}">
        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label for="name">제품명</label>
                <input type="text" id="name" name="name" class="form-control" placeholder="예: 무선 이어폰" required>
            </div>
            <div>
                <label for="sku">상품코드 (선택)</label>
                <input type="text" id="sku" name="sku" class="form-control" placeholder="예: WE001">
            </div>
        </div>
        
        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label for="cost_price">제품원가 (원)</label>
                <input type="number" id="cost_price" name="cost_price" class="form-control" placeholder="예: 25000" required>
            </div>
            <div>
                <label for="category">카테고리 (선택)</label>
                <input type="text" id="category" name="category" class="form-control" placeholder="예: 전자제품">
            </div>
        </div>
        
        <button type="submit" class="btn btn-success">제품 등록</button>
    </form>
</div>

<!-- 판매채널 등록 -->
<div class="card mt-4">
    <h3>판매채널 등록</h3>
    <form method="POST" action="{{ url_for('add_platform') }}">
        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label for="platform-name">채널명</label>
                <input type="text" id="platform-name" name="name" class="form-control" placeholder="예: 쿠팡, 11번가" required>
            </div>
            <div>
                <label for="commission-rate">수수료율 (%)</label>
                <input type="number" id="commission-rate" name="commission_rate" class="form-control" step="0.1" placeholder="예: 8.5" required>
            </div>
        </div>
        
        <button type="submit" class="btn btn-success">채널 등록</button>
    </form>
</div>

<!-- 등록된 제품 목록 -->
<div class="card mt-4">
    <h3>등록된 제품 목록</h3>
    {% if products %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>제품명</th>
                    <th>상품코드</th>
                    <th>원가</th>
                    <th>카테고리</th>
                    <th>등록일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr id="product-{{ product.id }}">
                    <td><strong>{{ product.name }}</strong></td>
                    <td>{{ product.sku or '-' }}</td>
                    <td>{{ '{:,.0f}'.format(product.cost_price) }} 원</td>
                    <td>{{ product.category or '-' }}</td>
                    <td>{{ product.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-product-btn" data-id="{{ product.id }}" data-name="{{ product.name }}">삭제</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align: center; color: #888; padding: 40px;">등록된 제품이 없습니다.</p>
    {% endif %}
</div>

<!-- 등록된 판매채널 목록 -->
<div class="card mt-4">
    <h3>등록된 판매채널</h3>
    {% if platforms %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>채널명</th>
                    <th>수수료율</th>
                    <th>등록일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                {% for platform in platforms %}
                <tr id="platform-{{ platform.id }}">
                    <td><strong>{{ platform.name }}</strong></td>
                    <td>{{ platform.commission_rate }}%</td>
                    <td>{{ platform.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-platform-btn" data-id="{{ platform.id }}" data-name="{{ platform.name }}">삭제</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align: center; color: #888; padding: 40px;">등록된 판매채널이 없습니다.</p>
    {% endif %}
</div>

<!-- 시작 가이드 -->
{% if not products and not platforms %}
<div class="card mt-4" style="background: linear-gradient(135deg, #00a6da, #0088b3); color: white;">
    <h3>시작 가이드</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
            <h4>1단계</h4>
            <p>제품을 등록하세요</p>
            <small>제품명과 원가를 입력합니다</small>
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
            <h4>2단계</h4>
            <p>판매채널을 등록하세요</p>
            <small>쿠팡, 11번가 등의 수수료율을 설정합니다</small>
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
            <h4>3단계</h4>
            <p>매출을 등록하세요</p>
            <small>개별 등록 또는 엑셀 업로드로 매출을 관리합니다</small>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 알림 메시지 표시 함수
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            padding: 15px 20px; border-radius: 8px; color: white; font-weight: bold;
            opacity: 0; transform: translateX(100%); transition: all 0.3s ease;
            background-color: ${type === 'success' ? '#28a745' : '#dc3545'};
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 제품 삭제
    document.querySelectorAll('.delete-product-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.id;
            const productName = this.dataset.name;
            
            if (!confirm(`정말 "${productName}" 제품을 삭제하시겠습니까?\n매출 데이터가 있으면 삭제할 수 없습니다.`)) {
                return;
            }
            
            fetch(`/business/products/delete/${productId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`product-${productId}`).remove();
                    showToast(data.message);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(() => showToast('삭제 중 오류가 발생했습니다.', 'error'));
        });
    });
    
    // 판매채널 삭제
    document.querySelectorAll('.delete-platform-btn').forEach(button => {
        button.addEventListener('click', function() {
            const platformId = this.dataset.id;
            const platformName = this.dataset.name;
            
            if (!confirm(`정말 "${platformName}" 판매채널을 삭제하시겠습니까?\n매출 데이터가 있으면 삭제할 수 없습니다.`)) {
                return;
            }
            
            fetch(`/business/platforms/delete/${platformId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`platform-${platformId}`).remove();
                    showToast(data.message);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(() => showToast('삭제 중 오류가 발생했습니다.', 'error'));
        });
    });
});
</script>

<style>
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .mt-4 {
        margin-top: 2rem;
    }
</style>
{% endblock %}